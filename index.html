<!DOCTYPE html>
<html>
<head>
    <title>WebAssembly WebGL Shaders</title>
    <script src="./wasm-arrays.js"></script>
    <script src="./dist/appWASM.js"></script>
    <script>

    let cache = {}
    "use strict"

    window.addEventListener("wasmLoaded", () => {

        console.log("wasmLoaded")

        let previewCanvasContext

        const createCanvas = (id, index, width, height) => {
            const canvas = document.createElement("canvas")
            canvas.id = id
            canvas.width = width
            canvas.height = height
            canvasContainer.appendChild(canvas)
            const context = canvas.getContext("webgl2")
            cache[id] = context
            const idBuffer = Module._malloc(id.length+1)
            Module.stringToUTF8(id, idBuffer, id.length+1)
            Module.ccall("createContext", null, ["number", "number", "number", "number"], [width, height, idBuffer, index])
        }

        const loadImage = src => {

            Module.ccall("clearContexts", null, null, null)

            const img = new Image()
            img.addEventListener("load", () => {

                const canvas = document.createElement("canvas")
                canvas.id = "previewCanvas"
                canvas.height = img.height
                canvas.width = img.width

                canvasContainer.innerHTML = ""
                previewCanvasContext = canvas.getContext("2d")
                previewCanvasContext.drawImage(img, 0, 0)
                canvasContainer.appendChild(canvas)

                createCanvas("textureLoad", 0, img.width, img.height)
                createCanvas("runTest", 1, img.width, img.height)
            })

            img.src = src
        }

        // Default image
        // loadImage("image.png")
        loadImage("image2.jpg")






        // File input
        fileInput.addEventListener("change", event => loadImage(URL.createObjectURL(event.target.files[0])))

        convert.addEventListener("click", () => {

            // Get imageData from the image
            const image = previewCanvasContext.getImageData(0, 0, previewCanvas.width, previewCanvas.height)
            const imageData = image.data


            const gl = cache['runTest']
            const texture = gl.createTexture()
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, image.width,image.height,0,gl.RGBA,gl.UNSIGNED_BYTE,image.data);


            console.log(texture)
            // 放置于 TEXTURE4
            gl.activeTexture(gl.TEXTURE4)
            gl.bindTexture(gl.TEXTURE_2D, texture)


            for (let i = 0; i < 100; i ++) {
            let t1 = new Date().getTime();

            // Pass the imageData to the C++ code
            // ccallArrays("loadTexture", null, ["array"], [imageData], {heapIn: "HEAPU8"})
            ccallArrays("runTest", null, ["array"], [imageData], {heapIn: "HEAPU8"})

            let t2 = new Date().getTime();
            console.log(t2 - t1);
            }

        })
    })
    </script>
</head>
<body>

<input id="fileInput" type="file" accept="image/*" value="./image.png">
<button id="convert">Convert</button>
<br>
<br>
<span id="canvasContainer"></span>

</body>
</html>